@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import implicits.ImplicitCurrencyFormatter._
@import enums._
@import models.financialTransactions.TransactionModel
@import models.calculation.CalcDisplayModel

@(calcModel: CalcDisplayModel, transactionModel: Option[TransactionModel], taxYear: Int)(implicit request: Request[_], messages: Messages, appConfig: config.FrontendAppConfig, user: auth.MtdItUser[_])

@defining(calcModel.calcDataModel.get) { breakdown =>

    <div class="form-group">
        <h2 id="how-calculated" class="heading">
            @if(calcModel.calcStatus == Estimate) {
                <span id="how-estimate-calculated">@messages("calc-breakdown.how-estimate-calculated", breakdown.totalIncomeTaxNicYtd.toCurrencyString)</span>
            } else {
                <span id="how-bill-calculated">@messages("calc-breakdown.how-bill-calculated")</span>
            }
            @breakdown.nationalRegime.map { regime =>
                <span id="national-regime" class="form-hint">@messages("calc-breakdown.national-regime", messages(regime))</span>
            }
        </h2>
    </div>

    <div class="form-group">
        <h3 id="income-heading" class="heading-small">@messages("calc-breakdown.income.heading")</h3>
        <div id="income-subheading" class="form-hint">@messages("calc-breakdown.income.sub-heading")</div>
    </div>

    @if(breakdown.incomeReceived.selfEmployment > 0) {
        <div id="business-profit-section" class="grid-row">
            <div class="column-half">
                <p id="business-profit-label">@messages("calc-breakdown.income.business-profit")</p>
            </div>
            <div class="column-half">
                <p id="business-profit-data" class="summary-data">@breakdown.incomeReceived.selfEmployment.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.incomeReceived.ukProperty > 0) {
        <!-- Income from Property -->
        <div id="property-income-section" class="grid-row">
            <div class="column-half">
                <p id="property-income-label">@messages("calc-breakdown.income.property")</p>
            </div>
            <div class="column-half">
                <p id="property-income-data" class="summary-data">@breakdown.incomeReceived.ukProperty.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.incomeReceived.ukDividends > 0) {
        <!-- Income from dividends -->
        <div id="dividend-income-section" class="grid-row">
            <div class="column-half">
                <p id="dividend-income-label">@messages("calc-breakdown.income.dividends")</p>
            </div>
            <div class="column-half">
                <p id="dividend-income-data" class="summary-data">@breakdown.incomeReceived.ukDividends.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.incomeReceived.bankBuildingSocietyInterest > 0) {
        <!-- Income from Savings -->
        <div id="savings-income-section" class="grid-row">
            <div class="column-half">
                <p id="savings-income-label">@messages("calc-breakdown.income.savings")</p>
            </div>
            <div class="column-half">
                <p id="savings-income-data" class="summary-data">@breakdown.incomeReceived.bankBuildingSocietyInterest.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.annualAllowances.personalAllowance > 0) {
        <!-- Deduction - Personal Allowance -->
        <div id="personal-allowance-section" class="grid-row">
            <div class="column-half">
                <p id="personal-allowance-label">@messages("calc-breakdown.income.personal-allowance")</p>
            </div>
            <div class="column-half">
                <p id="personal-allowance-data" class="summary-data panel-right">@breakdown.annualAllowances.personalAllowance.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.dividends.dividendsAllowance > 0) {
        <!-- Deduction - Dividends Allowance -->
        <div id="dividends-allowance-section" class="grid-row">
            <div class="column-half">
                <p id="dividends-allowance-label">@messages("calc-breakdown.income.dividends-allowance")</p>
            </div>
            <div class="column-half">
                <p id="dividends-allowance-data" class="summary-data panel-right">@breakdown.dividends.dividendsAllowance.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.savingsAndGains.savingsAllowance > 0) {
        <!-- Deduction - Savings Allowance -->
        <div id="savings-allowance-section" class="grid-row">
            <div class="column-half">
                <p id="savings-allowance-label">@messages("calc-breakdown.income.savings-allowance")</p>
            </div>
            <div class="column-half">
                <p id="savings-allowance-data" class="summary-data panel-right">@breakdown.savingsAndGains.savingsAllowance.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.giftOfInvestmentsAndPropertyToCharity > 0) {
        <!-- Deduction - gifts to investments and property to charity -->
        <div id="gift-investment-property-section" class="grid-row">
            <div class="column-half">
                <p id="gift-investment-property-label">@messages("calc-breakdown.income.gift-investment-property-to-charity")</p>
            </div>
            <div class="column-half">
                <p id="gift-investment-property-data" class="summary-data panel-right">@breakdown.giftOfInvestmentsAndPropertyToCharity.toCurrency</p>
            </div>
        </div>
    }

    <div id="total-taxable-income-section" class="grid-row total-section">
        @if(calcModel.calcStatus == Estimate) {
            <div class="column-half">
                <p id="estimate-total-taxable-income-label" class="bold">@messages("calc-breakdown.income.estimated-total-taxable-income")</p>
            </div>
            <div class="column-half">
                <p id="estimate-total-taxable-income-data" class="summary-data bold">@breakdown.totalTaxableIncome.toCurrency</p>
            </div>
        } else {
            <div class="column-half">
                <p id="total-taxable-income-label" class="bold">@messages("calc-breakdown.income.total-taxable-income")</p>
            </div>
            <div class="column-half">
                <p id="total-taxable-income-data" class="summary-data bold">@breakdown.totalTaxableIncome.toCurrency</p>
            </div>
        }
    </div>

    <br>
    <br>

    <div class="form-group">
        <h3 id="calculation-heading" class="heading-small">@messages("calc-breakdown.calculation.heading")</h3>
        <div id="calculation-subheading" class="form-hint">@messages("calc-breakdown.calculation.subheading", breakdown.totalTaxableIncome.toCurrencyString)</div>
        @if(breakdown.annualAllowances.giftAidExtender > 0) {
            <div id="gift-aid-extender" class="form-hint">@messages("calc-breakdown.calculation.gift-aid-extender", breakdown.annualAllowances.giftAidExtender.toCurrencyString)</div>
        }
    </div>

    @for(band <- breakdown.payAndPensionsProfit.payAndPensionsProfitBands if band.income > 0) {
        <!-- Income tax band -->
        <div id="income-tax-band-@{band.name}-section" class="grid-row">
            <div class="column-half">
                <p id="income-tax-band-@{band.name}-label">@messages("calc-breakdown.calculation.income-tax", band.income.toCurrencyString, band.rate.toString)</p>
            </div>
            <div class="column-half">
                <p id="income-tax-band-@{band.name}-data" class="summary-data">@band.taxAmount.toCurrency</p>
            </div>
        </div>
    }

    @for(band <- breakdown.dividends.band if band.income > 0) {
        <!-- Dividend band -->
        <div id="dividend-tax-band-@{band.name}-section" class="grid-row">
            <div class="column-half">
                <p id="dividend-tax-band-@{band.name}-label">@messages("calc-breakdown.calculation.dividend", band.income.toCurrencyString, band.rate.toString)</p>
            </div>
            <div class="column-half">
                <p id="dividend-tax-band-@{band.name}-data" class="summary-data">@band.amount.toCurrency</p>
            </div>
        </div>
    }

    @for(band <- breakdown.savingsAndGains.bands if band.taxableIncome > 0) {
        <!-- Savings and Gains band -->
        <div id="savings-tax-band-@{band.name}-section" class="grid-row">
            <div class="column-half">
                <p id="savings-tax-band-@{band.name}-label">@messages("calc-breakdown.calculation.savings", band.taxableIncome.toCurrencyString, band.taxRate.toString)</p>
            </div>
            <div class="column-half">
                <p id="savings-tax-band-@{band.name}-data" class="summary-data">@band.taxAmount.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.nic.class2 > 0) {
        <!-- Class 2 National Insurance -->
        <div id="nic-class2-section" class="grid-row">
            <div class="column-half">
                <p id="nic-class2-label">@messages("calc-breakdown.calculation.class-two-ni")</p>
            </div>
            <div class="column-half">
                <p id="nic-class2-data" class="summary-data">@breakdown.nic.class2.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.nic.class4 > 0) {
        <!-- Class 4 National Insurance -->
        <div id="nic-class4-section" class="grid-row">
            <div class="column-half">
                <p id="nic-class4-label">@messages("calc-breakdown.calculation.class-four-ni")</p>
            </div>
            <div class="column-half">
                <p id="nic-class4-data" class="summary-data">@breakdown.nic.class4.toCurrency</p>
            </div>
        </div>
    }

    @if(breakdown.taxReliefs > 0) {
        <!-- Tax Reliefs -->
        <div id="tax-reliefs-section" class="grid-row">
            <div class="column-half">
                <p id="tax-reliefs-label">@messages("calc-breakdown.calculation.tax-relief")</p>
            </div>
            <div class="column-half">
                <p id="tax-reliefs-data" class="summary-data panel-right">@breakdown.taxReliefs.toCurrency</p>
            </div>
        </div>
    }

    @transactionModel.map { model =>
        <div id="total-tax-bill-section" class="total-section grid-row">
            <div class="column-half">
                <p id="total-tax-bill-label" class="bold">@messages("calc-breakdown.calculation.total-bill-amount")</p>
            </div>
            <div class="column-half">
                <p id="total-tax-bill-data" class="summary-data bold">@model.originalAmount.getOrElse[BigDecimal](0).toCurrency</p>
            </div>
        </div>

        <div id="payments-to-date-section" class="grid-row">
            <div class="column-half">
                <p id="payments-to-date-label">@messages("calc-breakdown.calculation.payments-to-date")</p>
            </div>
            <div class="column-half">
                <p id="payments-to-date-data" class="summary-data panel-right">@model.clearedAmount.getOrElse[BigDecimal](0).toCurrency</p>
            </div>
        </div>
    }

    <div id="your-total-section" class="total-section grid-row">
        @if(calcModel.calcStatus == Estimate) {
            <div class="column-half">
                <p id="your-total-estimate-label" class="bold">@messages("calc-breakdown.calculation.total-estimated-tax")</p>
            </div>
            <div class="column-half">
                <p id="your-total-estimate-data" class="summary-data bold">@breakdown.totalIncomeTaxNicYtd.toCurrency</p>
            </div>
        } else {
            <div class="column-half">
                <div id="total-outstanding-label" class="bold">@messages("calc-breakdown.calculation.total-outstanding-tax")</div>
                <div id="total-outstanding-date" class="form-hint">@messages("calc-breakdown.calculation.due-date", (taxYear+1).toString)</div>
            </div>
            <div class="column-half">
                @transactionModel.map { model =>
                    <p id="total-outstanding-data" class="summary-data bold">@model.outstandingAmount.getOrElse[BigDecimal](0).toCurrency</p>
                }
            </div>
        }
    </div>

}
