@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import implicits.ImplicitCurrencyFormatter._
@import enums._
@import models.financialTransactions.TransactionModel
@import models.calculation.CalcDisplayModel

@(calcModel: CalcDisplayModel, transactionModel: Option[TransactionModel], taxYear: Int)(implicit request: Request[_], messages: Messages, appConfig: config.FrontendAppConfig, user: auth.MtdItUser[_])

@defining(calcModel.calcDataModel.get) { breakdown =>
    <table class="itvc-table">
        <tbody>

        @if(breakdown.nationalRegime.nonEmpty){
            <tr id="national-regime-section"  class="no-border-bottom">
                <td id="national-regime-heading">@messages("estimated_tax_liability.calc-breakdown.nationalRegime")</td>
                <td id="national-regime" class="summary-data">@breakdown.nationalRegime</td>
            </tr>
        }
        <tr id="business-profit-section" class="no-border-bottom">
            <td id="business-profit-heading">
                @{
                    if(CalcDisplayModel.selfEmployedIncomeOrReceived(user, taxYear, breakdown)) {
                        messages("estimated_tax_liability.calc-breakdown.business-profit")
                    } else if(CalcDisplayModel.propertyIncomeOrReceived(user, taxYear, breakdown)) {
                        messages("estimated_tax_liability.calc-breakdown.property-profit")
                    }
                }
                @if(calcModel.estimatedWithBBSInterest) {@messages("estimated_tax_liability.calc-breakdown.and-savings")}
            </td>

            <td id="business-profit"  class="summary-data">
                @{
                    if(calcModel.calcStatus == Estimate){(breakdown.incomeReceived.estimateBuisnessProfit).toCurrency}
                    else { (breakdown.incomeReceived.buisnessProfit).toCurrency}
                }

            </td>
        </tr>

        @if(calcModel.crystallisedWithBBSInterest){
            <tr id="savings-income-section"  class="no-border-bottom">
                <td id="savings-income-heading">@messages("estimated_tax_liability.calc-breakdown.income-savings")</td>
                <td id="savings-income" class="summary-data">@breakdown.incomeReceived.bankBuildingSocietyInterest.toCurrency</td>
            </tr>
        }

        @if(breakdown.savingsAllowanceSummaryData == 0 && breakdown.additionalAllowances == 0) {
        <tr id="personal-allowance-section">
        } else {
        <tr id="personal-allowance-section" class="no-border-bottom">
        }
            <td id="personal-allowance-heading">
                @{messages("estimated_tax_liability.calc-breakdown.pa-estimates")}
            </td>
            <td id="personal-allowance" class="summary-data">
                -@{breakdown.personalAllowance.toCurrency}
            </td>
        </tr>

        @if(breakdown.savingsAllowanceSummaryData > 0) {

        @if(breakdown.additionalAllowances <= 0 ) {
        <tr id="savings-allowance-section">
        } else {
        <tr id="savings-allowance-section" class="no-border-bottom">
        }
            <td id="savings-allowance-heading">
                @{messages("estimated_tax_liability.calc-breakdown" + calcModel.savingsAllowanceHeading)}
            </td>
            <td id="savings-allowance" class="summary-data">
                -@{breakdown.savingsAllowanceSummaryData.toCurrency}
            </td>
        </tr>

        }

        @if(breakdown.additionalAllowances > 0) {
        <tr id="additional-allowances-section">
            <td id="additional-allowances-heading">
                @messages("estimated_tax_liability.calc-breakdown.additional-allowances")
            </td>
            <td id="additional-allowances" class="summary-data">
                -@{(breakdown.additionalAllowances).toCurrency}
            </td>
        </tr>
        }

        <tr id="taxable-income-section" class="total-section">
            <td id="taxable-income-heading">@messages("estimated_tax_liability.calc-breakdown.taxable-income")</td>
            <td id="taxable-income" class="summary-data">@breakdown.taxableIncomeTaxIncome.toCurrency</td>
        </tr>

        @if(breakdown.incomeReceived.ukDividends > 0) {
        <tr class="no-border-bottom">
            <td id="dividend-income-heading">@messages("estimated_tax_liability.calc-breakdown.dividend-income")</td>
            <td id="dividend-income" class="summary-data">@breakdown.incomeReceived.ukDividends.toCurrency</td>
            </tr>

        <tr>
            <td id="dividend-allowance-heading">@messages("estimated_tax_liability.calc-breakdown.dividend-allowance")</td>
            <td id="dividend-allowance" class="summary-data">-@breakdown.dividends.allowance.toCurrency</td>
        </tr>

        <tr class="total-section">
            <td id="taxable-dividend-income-heading">@messages("estimated_tax_liability.calc-breakdown.taxable-dividend-income")</td>
            <td id="taxable-dividend-income" class="summary-data">@breakdown.taxableDividendIncome.toCurrency</td>
        </tr>
        }

        <!-- Income Tax Section from PayPensionsProfit-->

        @for(band <- breakdown.payAndPensionsProfitBands if band.income > 0) {
            <tr id="@{band.name}Ppp-section" class="no-border-bottom">
                <td id="@{band.name}Ppp-it-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.payPensionsProfit-income", band.income.toCurrencyString, band.rate.toString)
                </td>
                <td id="@{band.name}Ppp-amount" class="summary-data">
                    @band.amount.toCurrency
                </td>
            </tr>
        }

        <!-- Income Tax Section from savingsInterest-->
        @if(calcModel.hasSRTSiSection) {
            <tr id="srtSi-section" class="no-border-bottom">
                <td id="srtSi-it-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.savingsInterest-income")
                    (<span id="srtSi-it-calcPpp">@{breakdown.srtSiITCalc.toCurrencyString}</span>
                    @messages("estimated_tax_liability.calc-breakdown.at")
                    <span id="srtSi-rate">@breakdown.savingsAndGains.startBand.taxRate</span>%)
                </td>
                <td id="srtSi-amount" class="summary-data">@{(breakdown.srtSiITAmount).toCurrency}</td>
            </tr>

        @if(calcModel.hasZRTSiSection) {
            <tr id="zrtSi-section" class="no-border-bottom">
                <td id="zrtSi-it-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.savingsInterest-income")
                    (<span id="zrtSi-it-calcPpp">@{breakdown.zrtSiITCalc.toCurrencyString}</span>
                    @messages("estimated_tax_liability.calc-breakdown.at")
                    <span id="zrtSi-rate">@breakdown.savingsAndGains.zeroBand.taxRate</span>%)
                </td>
                <td id="zrtSi-amount" class="summary-data">@{(breakdown.zrtSiITAmount).toCurrency}</td>
            </tr>

        @if(calcModel.hasBRTSiSection) {
            <tr id="brtSi-section" class="no-border-bottom">
                <td id="brtSi-it-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.savingsInterest-income")
                    (<span id="brtSi-it-calcPpp">@{breakdown.brtSiITCalc.toCurrencyString}</span>
                    @messages("estimated_tax_liability.calc-breakdown.at")
                    <span id="brtSi-rate">@breakdown.savingsAndGains.basicBand.taxRate</span>%)
                </td>
                <td id="brtSi-amount" class="summary-data">@{(breakdown.brtSiITAmount).toCurrency}</td>
            </tr>

        @if(calcModel.hasHRTSiSection){
            <tr id="hrtSi-section" class="no-border-bottom">
                 <td id="hrtSi-it-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.savingsInterest-income")
                    (<span id="hrtSi-it-calc"> @{breakdown.hrtSiITCalc.toCurrencyString}</span>
                    @messages("estimated_tax_liability.calc-breakdown.at")
                    <span id="hrtSi-rate">@breakdown.savingsAndGains.higherBand.taxRate</span>%)
                 </td>
                 <td id="hrtSi-amount" class="summary-data">@{breakdown.hrtSiITAmount.toCurrency}</td>
            </tr>

        @if(calcModel.hasARTSiSection){
            <tr id="artSi-section" class="no-border-bottom">
                <td id="artSi-it-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.savingsInterest-income")
                    (<span id="artSi-it-calc">@{breakdown.artSiITCalc.toCurrencyString}</span>
                    @messages("estimated_tax_liability.calc-breakdown.at")
                    <span id="artSi-rate">@breakdown.savingsAndGains.additionalBand.taxRate</span>%)
                </td>
                <td id="artSi-amount" class="summary-data">@{breakdown.artSiITAmount.toCurrency}</td>
            </tr>
                        }
                    }
                }
            }
        }

        <!-- Dividends Section -->
        @if(breakdown.hasDividendsAtBRT) {
            <tr id="dividend-brt-section" class="no-border-bottom">
                <td id="dividend-brt-calc-heading">
                    @messages("estimated_tax_liability.calc-breakdown.dividend-tax")
                    (<span id="dividend-brt-calc">@breakdown.dividends.basicBand.taxableIncome.toCurrencyString</span>
                    @messages("estimated_tax_liability.calc-breakdown.at")
                    <span id="dividend-brt-rate">@breakdown.dividends.basicBand.taxRate</span>%)
                </td>
                <td id="dividend-brt-amount" class="summary-data">@breakdown.dividends.basicBand.taxAmount.toCurrency</td>
            </tr>

            @if(breakdown.hasDividendsAtHRT) {
                <tr id="dividend-hrt-section" class="no-border-bottom">
                    <td id="dividend-hrt-calc-heading">
                        @messages("estimated_tax_liability.calc-breakdown.dividend-tax")
                        (<span id="dividend-hrt-calc">@breakdown.dividends.higherBand.taxableIncome.toCurrencyString</span>
                        @messages("estimated_tax_liability.calc-breakdown.at")
                        <span id="dividend-hrt-rate">@breakdown.dividends.higherBand.taxRate</span>%)
                    </td>
                    <td id="dividend-hrt-amount" class="summary-data">@breakdown.dividends.higherBand.taxAmount.toCurrency</td>
                </tr>

                @if(breakdown.hasDividendsAtART) {
                    <tr id="dividend-art-section" class="no-border-bottom">
                        <td id="dividend-art-calc-heading">
                            @messages("estimated_tax_liability.calc-breakdown.dividend-tax")
                            (<span id="dividend-art-calc">@breakdown.dividends.additionalBand.taxableIncome.toCurrencyString</span>
                            @messages("estimated_tax_liability.calc-breakdown.at")
                            <span id="dividend-art-rate">@breakdown.dividends.additionalBand.taxRate</span>%)
                        </td>
                        <td id="dividend-art-amount" class="summary-data">@breakdown.dividends.additionalBand.taxAmount.toCurrency</td>
                    </tr>
                }
            }
        }



        @if(calcModel.hasNISection) {
            <section id ="ni-section">
                @if(calcModel.hasNic2Amount) {
                    <tr @if(calcModel.hasNic4Amount || calcModel.hasTaxReliefs){class="no-border-bottom"}>
                        <td id="nic2-amount-heading">@messages("estimated_tax_liability.calc-breakdown.nic2")</td>
                        <td id="nic2-amount" class="summary-data">@breakdown.nic.class2.toCurrency</td>
                    </tr>
                }
                @if(calcModel.hasNic4Amount) {
                    <tr @if(calcModel.hasTaxReliefs){class="no-border-bottom"}>
                        <td id="nic4-amount-heading">@messages("estimated_tax_liability.calc-breakdown.nic4")</td>
                        <td id="nic4-amount" class="summary-data">@breakdown.nic.class4.toCurrency</td>
                    </tr>
                }
            </section>
        }


        @if(calcModel.hasTaxReliefs) {
        <tr>
            <td id="tax-relief-heading">@messages("estimated_tax_liability.calc-breakdown.reliefs")</td>
            <td id="tax-relief" class="summary-data">-@breakdown.taxReliefs.toCurrency</td>
        </tr>
        }


        @if(calcModel.calcStatus == Estimate) {
            <tr class="total-section">
                <td id="total-estimate-heading">@messages("estimated_tax_liability.calc-breakdown.total-estimate")</td>
                <td id="total-estimate" class="summary-data">@breakdown.totalIncomeTaxNicYtd.toCurrency</td>
            </tr>
        }else{
            <tr class="total-section">
                <td id="total-estimate-heading">@messages("crystalisation.calc-breakdown.subtotal")</td>
                <td id="total-estimate" class="summary-data">@breakdown.totalIncomeTaxNicYtd.toCurrency</td>
            </tr>
            <tr>
                <td id="payment-heading">@messages("crystalisation.calc-breakdown.payment")</td>
                <td id="payment" class="summary-data">-@transactionModel.get.clearedAmount.getOrElse[BigDecimal](0).toCurrency</td>
            </tr>
            <tr class="total-section">
                <td id="owed-heading">@messages("crystalisation.calc-breakdown.owed", s"${taxYear+1}")</td>
                <td id="owed" class="summary-data">@transactionModel.get.outstandingAmount.getOrElse[BigDecimal](0).toCurrency</td>
            </tr>
        }

        </tbody>
    </table>
    }

